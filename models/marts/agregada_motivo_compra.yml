version: 2

models:
  - name: agregada_motivo_compras
    description: "Tabela agregada de motivos de compras"
    columns:
      - name: id_pedido
        description: "Identificador do pedido"
      - name: id_motivo
        description: "Identificador do motivo da compra"
      - name: nome_razao_motivo
        description: "Nome da razão do motivo da compra"
      - name: nome_motivo
        description: "Nome do motivo da compra"
      - name: data_fk
        description: "Chave estrangeira para a dimensão de data"
    depends_on:
      - model: fato_vendas
      - model: stg_sap__salesorderheadersalesreason
      - model: stg_sap__salesreason
    sql: |
      with 
        fato_vendas as (
            select 
                cast(id_pedido as string) as id_pedido,
                data_fk
            from fato_vendas
        ),
        salesorderheadersalesreason as (
            select 
                cast(id_pedido as string) as id_pedido,
                cast(id_motivo as string) as id_motivo
            from stg_sap__salesorderheadersalesreason
        ),
        salesreason as (
            select 
                cast(id_motivo as string) as id_motivo,
                nome_razao_motivo,
                nome_motivo
            from stg_sap__salesreason
        ),
        join_sales_reason as (
            select
                salesorderheadersalesreason.id_pedido,
                salesorderheadersalesreason.id_motivo,
                salesreason.nome_razao_motivo,
                salesreason.nome_motivo
            from salesorderheadersalesreason
            left join salesreason on
                salesorderheadersalesreason.id_motivo = salesreason.id_motivo
        ),
        final as (
            select 
                fato_vendas.id_pedido,
                coalesce(join_sales_reason.id_motivo, 'Nao_informado') as id_motivo,
                coalesce(join_sales_reason.nome_razao_motivo, 'Nao_informado') as nome_razao_motivo,
                coalesce(join_sales_reason.nome_motivo, 'Nao_informado') as nome_motivo,
                fato_vendas.data_fk
            from fato_vendas
            left join join_sales_reason on
                join_sales_reason.id_pedido = fato_vendas.id_pedido
        )
      select *
      from final
