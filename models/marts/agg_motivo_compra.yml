version: 2

models:
  - name: fato_vendas
    description: "Transformed data from fct_vendas"
    config:
      materialized: view
    sql: |
      select 
          cast(id_pedido as string) as id_pedido,
          data_fk
      from {{ ref('fct_vendas') }}

  - name: salesorderheadersalesreason
    description: "Transformed data from stg_sap__salesorderheadersalesreason"
    config:
      materialized: view
    sql: |
      select 
          cast(id_pedido as string) as id_pedido,
          cast(id_motivo as string) as id_motivo
      from {{ ref('stg_sap__salesorderheadersalesreason') }}

  - name: salesreason
    description: "Transformed data from stg_sap__salesreason"
    config:
      materialized: view
    sql: |
      select 
          cast(id_motivo as string) as id_motivo,
          nome_razao_motivo,
          nome_motivo
      from {{ ref('stg_sap__salesreason') }}

  - name: join_sales_reason
    description: "Joining salesorderheadersalesreason with salesreason"
    config:
      materialized: view
    sql: |
      select
          salesorderheadersalesreason.id_pedido,
          salesorderheadersalesreason.id_motivo,
          salesreason.nome_razao_motivo,
          salesreason.nome_motivo
      from salesorderheadersalesreason
      left join salesreason on
          salesorderheadersalesreason.id_motivo = salesreason.id_motivo

  - name: final
    description: "Final aggregation of sales reason data"
    config:
      materialized: view
    sql: |
      select 
          fato_vendas.id_pedido,
          coalesce (join_sales_reason.id_motivo, "Nao_informado") as id_motivo,
          coalesce (join_sales_reason.nome_razao_motivo, "Nao_informado") as nome_razao_motivo,
          coalesce (join_sales_reason.nome_motivo, "Nao_informado") as nome_motivo,
          fato_vendas.data_fk
      from fato_vendas
      left join join_sales_reason on
          join_sales_reason.id_pedido = fato_vendas.id_pedido
